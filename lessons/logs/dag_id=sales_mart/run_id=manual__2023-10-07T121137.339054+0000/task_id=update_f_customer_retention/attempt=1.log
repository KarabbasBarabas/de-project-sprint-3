[2023-10-07 12:12:56,791] {taskinstance.py:1159} INFO - Dependencies all met for <TaskInstance: sales_mart.update_f_customer_retention manual__2023-10-07T12:11:37.339054+00:00 [queued]>
[2023-10-07 12:12:56,797] {taskinstance.py:1159} INFO - Dependencies all met for <TaskInstance: sales_mart.update_f_customer_retention manual__2023-10-07T12:11:37.339054+00:00 [queued]>
[2023-10-07 12:12:56,798] {taskinstance.py:1356} INFO - 
--------------------------------------------------------------------------------
[2023-10-07 12:12:56,799] {taskinstance.py:1357} INFO - Starting attempt 1 of 1
[2023-10-07 12:12:56,799] {taskinstance.py:1358} INFO - 
--------------------------------------------------------------------------------
[2023-10-07 12:12:56,808] {taskinstance.py:1377} INFO - Executing <Task(PostgresOperator): update_f_customer_retention> on 2023-10-07 12:11:37.339054+00:00
[2023-10-07 12:12:56,811] {standard_task_runner.py:52} INFO - Started process 3892 to run task
[2023-10-07 12:12:56,813] {standard_task_runner.py:79} INFO - Running: ['airflow', 'tasks', 'run', 'sales_mart', 'update_f_customer_retention', 'manual__2023-10-07T12:11:37.339054+00:00', '--job-id', '90', '--raw', '--subdir', 'DAGS_FOLDER/sprint3.py', '--cfg-path', '/tmp/tmp5pqb4hdk', '--error-file', '/tmp/tmpvblwud03']
[2023-10-07 12:12:56,814] {standard_task_runner.py:80} INFO - Job 90: Subtask update_f_customer_retention
[2023-10-07 12:12:56,849] {task_command.py:369} INFO - Running <TaskInstance: sales_mart.update_f_customer_retention manual__2023-10-07T12:11:37.339054+00:00 [running]> on host 70ec72ace0d7
[2023-10-07 12:12:56,890] {taskinstance.py:1569} INFO - Exporting the following env vars:
AIRFLOW_CTX_DAG_EMAIL=student@example.com
AIRFLOW_CTX_DAG_OWNER=student
AIRFLOW_CTX_DAG_ID=sales_mart
AIRFLOW_CTX_TASK_ID=update_f_customer_retention
AIRFLOW_CTX_EXECUTION_DATE=2023-10-07T12:11:37.339054+00:00
AIRFLOW_CTX_TRY_NUMBER=1
AIRFLOW_CTX_DAG_RUN_ID=manual__2023-10-07T12:11:37.339054+00:00
[2023-10-07 12:12:56,896] {base.py:68} INFO - Using connection ID 'postgresql_de' for task execution.
[2023-10-07 12:12:56,900] {sql.py:315} INFO - Running statement: insert into mart.f_customer_retention(
    period_name 
    ,period_id 
    ,item_id 
    ,new_customers_count 
    ,returning_customers_count
    ,refunded_customer_count 
    ,new_customers_revenue 
    ,returning_customers_revenue 
    ,customers_refunded  
)

select
    'weekly' as period_name 
    ,t.period_id 
    ,t.item_id 
    ,t.new_customers_count 
    ,t.returning_customers_count
    ,t.refunded_customer_count 
    ,t.new_customers_revenue 
    ,t.returning_customers_revenue 
    ,t.customers_refunded 
from(
    select
        --'weekly' as period_name
        q.period_id
        ,q.item_id
        ,sum(case when cnt_sales = 1 then 1 else 0 end) as new_customers_count
        ,sum(case when cnt_sales > 1 then 1 else 0 end) as returning_customers_count
        ,sum(case when cnt_rej >= 1 then 1 else 0 end) as refunded_customer_count
        ,sum(case when cnt_sales = 1 then payment_amount else 0 end ) as new_customers_revenue
        ,sum(case when cnt_sales > 1 then payment_amount else 0 end ) as returning_customers_revenue
        ,sum(cnt_rej) as customers_refunded
    from(
        select
            dc.first_day_of_week as period_id
            ,fs.item_id
            ,fs.customer_id
            ,count(*) as cnt_sales
            ,sum(
                case
                    when fs.status = 'refunded' then 1
                    else 0
                end
            ) as cnt_rej
            ,sum(payment_amount) as payment_amount
        from mart.f_sales fs  
        left join mart.d_calendar dc on fs.date_id = dc.date_id
        group by dc.first_day_of_week
                ,fs.item_id
                ,fs.customer_id
    ) q
    group by q.period_id
            ,q.item_id
) t , parameters: {'date': ('{{ ds }}',)}
[2023-10-07 12:12:56,901] {taskinstance.py:1889} ERROR - Task failed with exception
Traceback (most recent call last):
  File "/usr/local/lib/python3.8/dist-packages/airflow/providers/postgres/operators/postgres.py", line 94, in execute
    self.hook.run(self.sql, self.autocommit, parameters=self.parameters)
  File "/usr/local/lib/python3.8/dist-packages/airflow/providers/common/sql/hooks/sql.py", line 295, in run
    self._run_command(cur, sql_statement, parameters)
  File "/usr/local/lib/python3.8/dist-packages/airflow/providers/common/sql/hooks/sql.py", line 318, in _run_command
    cur.execute(sql_statement, parameters)
psycopg2.errors.UndefinedTable: relation "mart.f_customer_retention" does not exist
LINE 1: insert into mart.f_customer_retention(
                    ^

[2023-10-07 12:12:56,908] {taskinstance.py:1395} INFO - Marking task as FAILED. dag_id=sales_mart, task_id=update_f_customer_retention, execution_date=20231007T121137, start_date=20231007T121256, end_date=20231007T121256
[2023-10-07 12:12:56,914] {standard_task_runner.py:92} ERROR - Failed to execute job 90 for task update_f_customer_retention (relation "mart.f_customer_retention" does not exist
LINE 1: insert into mart.f_customer_retention(
                    ^
; 3892)
[2023-10-07 12:12:56,947] {local_task_job.py:156} INFO - Task exited with return code 1
[2023-10-07 12:12:56,970] {local_task_job.py:273} INFO - 0 downstream tasks scheduled from follow-on schedule check
